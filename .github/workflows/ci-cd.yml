# .github/workflows/ci-cd.yml
name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE: sentiment-api
  DOCKER_TAG: ${{ github.sha }}

jobs:
  # Job 1: Code Quality & Testing
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ“Š Create Mock Data
      run: python src/create_mock_data.py
    
    - name: ğŸ¤– Train Model
      run: python src/train.py
    
    - name: ğŸ§ª Test Model Loading
      run: python src/test_model_loading.py
    
    - name: ğŸ“ˆ Validate Model Metrics
      run: |
        if [ ! -f "models/sentiment_model.pkl" ]; then
          echo "âŒ Model file not found!"
          exit 1
        fi
        if [ ! -f "metrics.json" ]; then
          echo "âŒ Metrics file not found!"
          exit 1
        fi
        echo "âœ… Model and metrics validation passed!"
    
    - name: ğŸ“‹ Upload Model Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: |
          models/
          metrics.json
        retention-days: 30

  # Job 2: Docker Build & Test
  docker-build:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download Model Artifacts
      uses: actions/download-artifact@v4
      with:
        name: trained-model
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ”¨ Build Docker Image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} .
        docker build -t ${{ env.DOCKER_IMAGE }}:latest .
    
    - name: ğŸ§ª Test Docker Container
      run: |
        # Start container
        docker run -d --name test-container -p 8000:8000 ${{ env.DOCKER_IMAGE }}:latest
        
        # Wait for startup
        sleep 30
        
        # Test health endpoint
        curl -f http://localhost:8000/ || exit 1
        
        # Test prediction endpoint
        curl -X POST http://localhost:8000/predict \
          -H "Content-Type: application/json" \
          -d '{"text": "GitHub Actions is awesome!"}' || exit 1
        
        # Stop container
        docker stop test-container
        docker rm test-container
        
        echo "âœ… Docker container tests passed!"
    
    - name: ğŸ’¾ Save Docker Image
      run: |
        docker save ${{ env.DOCKER_IMAGE }}:latest | gzip > sentiment-api.tar.gz
    
    - name: ğŸ“‹ Upload Docker Image
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: sentiment-api.tar.gz
        retention-days: 7

  # Job 3: Security Scan (Simplified)
  security-scan:
    needs: docker-build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ” Run Basic Security Check
      run: |
        echo "ğŸ” Running basic security checks..."
        
        # Check for common security issues
        echo "Checking for hardcoded secrets..."
        if grep -r "password\|secret\|key" --include="*.py" src/ || true; then
          echo "âš ï¸ Potential hardcoded secrets found (review manually)"
        fi
        
        # Check Python dependencies for known vulnerabilities
        pip install safety
        safety check -r requirements.txt || echo "âš ï¸ Some vulnerabilities found in dependencies"
        
        echo "âœ… Security scan completed"

  # Job 4: Deploy (only on main branch)
  deploy:
    if: github.ref == 'refs/heads/main'
    needs: [test, docker-build]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download Docker Image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
    
    - name: ğŸ³ Load Docker Image
      run: |
        docker load < sentiment-api.tar.gz
        docker images
    
    - name: ğŸš€ Deploy to Staging
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        
        docker run -d --name staging-deployment -p 8080:8000 ${{ env.DOCKER_IMAGE }}:latest
        sleep 30
        
        # Smoke test
        curl -f http://localhost:8080/ || exit 1
        
        echo "âœ… Staging deployment successful!"
        
        # Clean up
        docker stop staging-deployment
        docker rm staging-deployment
    
    - name: ğŸ“Š Performance Test
      run: |
        echo "ğŸ“Š Running performance tests..."
        
        docker run -d --name perf-test -p 8090:8000 ${{ env.DOCKER_IMAGE }}:latest
        sleep 30
        
        # Run multiple requests
        for i in {1..5}; do
          echo "Request $i..."
          curl -X POST http://localhost:8090/predict \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"Performance test $i\"}" || exit 1
          sleep 1
        done
        
        echo "âœ… Performance tests passed!"
        
        # Clean up
        docker stop perf-test
        docker rm perf-test
    
    - name: ğŸ‰ Deployment Complete
      run: |
        echo "ğŸ‰ MLOps Pipeline completed successfully!"
        echo "âœ… Model trained and validated"
        echo "âœ… Docker image built and tested"  
        echo "âœ… Security scan completed"
        echo "âœ… Staging deployment successful"
        echo "âœ… Performance tests passed"
        echo ""
        echo "ğŸ“Š Pipeline Summary:"
        echo "- Model Accuracy: Check artifacts for metrics.json"
        echo "- Docker Image: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}"
        echo "- Deployment Status: Success"